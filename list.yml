- block:
    - name: GitLab Post | Check if root user password is set
      uri:
        url: https://gitlab.{{ dns_domain_name }}/oauth/token
        method: POST
        validate_certs: no
        status_code: 200
        body_format: json
        headers:
          Content-Type: application/json
        body: >
          {
            "grant_type": "password",
            "username": "root",
            "password": "{{ domain_admin_password }}"
          }
      no_log: True
  rescue:
    - name: GitLab Post | Copy root password script to host
      template:
        src: set_root_pw.sh.j2
        dest: /root/set_root_pw.sh
        owner: root
        group: root
        mode: 0700

    - name: GitLab Post | Execute set root password
      command: ./set_root_pw.sh
      args:
        chdir: /root

    - name: GitLab Post | Remove set root password script
      file:
        path: /root/set_root_pw.sh
        state: absent

    - name: GitLab Post | Wait for root user to initizalize
      uri:
        url: https://gitlab.{{ dns_domain_name }}/oauth/token
        method: POST
        validate_certs: no
        status_code: 200
        body_format: json
        headers:
          Content-Type: application/json
        body: >
          {
            "grant_type": "password",
            "username": "root",
            "password": "{{ domain_admin_password }}"
          }
      register: gitlab_access_token
      until: gitlab_access_token is success and gitlab_access_token.json.access_token is defined
      delay: 3
      retries: 60